[TOC]

具体场景需求见此文档 [github 微前端阶段2](https://github.com/yicheny/frontend-target/blob/main/biz/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E5%BE%AE%E5%89%8D%E7%AB%AF%E9%98%B6%E6%AE%B52.md)

# 设计分析
根据之前的文档，脚本需要做的事情已经明确了：
1. 假设分支`x`需要修复缺陷/添加需求，在对应业务的子项目的x分支进行修改
2. 使用`mpm`同步所有项目的分支
3. 使用`mpm`合回主线，如果出现冲突则手动解决

实现这部分需求有几种方案：
1. 通过`gitlab`接口实现对远端项目的修改，这个方案问题在于我之前没有使用过脚本控制`gitlab`，有一定的风险，目前`27`版本是需要在`9.14`发布的，现在大概剩下两周时间，我希望留一周给测试。然后我还有其他一些微前端改造需要去做，所以我实际可以用于开发`mpm`的时间大概不到一周，所以这个方案我希望留到二期去做。
2. 通过本地控制`git`提交然后推送到远端，从配置和效果上来说，和方案1是相同的，除了实现之外，有一个需要注意的是，对项目结构有所要求（不过这个本来也是必要，因为期望通过约束目录结构以实现多项目管理，这是另一部分多项目管理的需要）。这是一个过度方案，我预期是我自己控制，不过我会提供一份文档，有需要的话其他人可以按照文档使用---这份文档本来就需要，方案2也需要的，因为脚本需要提供文档说明怎么使用。

方案2的实现和我之前写过的`project-share`脚本类似，这个脚本思路和`git subtree`类似，不过是用于`svn`的公共模块同步的一个东西，这个脚本的核心是`node`和`svn`，`svn`也是版本控制工具，虽然命令不同，不过和`git`还是有很多相通之处的。

因为我写过`project-share`，所以对这个方案的实现更有信心，思路也更明确，一期我会使用这个思路实现`mpm`。

## 插件系统
目前，我想实现一套插件系统，由这个工具提供一切基本功能，把插件需要的参数和环境传递进来，然后由插件自己控制和实现功能，如此以来，可以更好的适应不同项目的不同需求。

其实我认为这是设计上的弹性，也是程序扩展性的一种体现，如果由功能实现某种具体的功能，当然是可以的，但如此以来工具就完全受限于某种具体的需求，难以实现变化。

这里如果让工具实现某些公共的流程和处理，将具体的操作交给插件系统，并且让配置文件进行一些基本配置，就可以实现更加弹性的需要。

目前从层次上来说：
1. `mpm`库实现公共流程和基本处理，这部分是基础，我们通常认为这部分是稳定的，即便有新的需求，也基本不会对这里进行改动
2. `plugin`这部分可以由开发者提供，可以是`mpm`库的开发者，也可以是项目上的开发者，只要遵守`mpm`提供的`API`和规范，就可以实现一套满足项目需要的插件并使用。这部分插件是公共的，可以被复用的部分，根据需求可以开发和替换相应的插件
3. 业务项目只需要配置`mpm.config.js`这类配置文件即可

可以看到，这种设计我们做了两个层次的拆分：
1. 将不会变化的部分和频繁变化的部分做了拆分（`mpm`库和插件）
2. 将复用和不可复用的部分做了拆分（`mpm`库、插件、项目配置）

以我之前开发的两个脚本`project-share`和`dynamic-pack`为例，就不具有弹性，一旦需求或环境发生变化就很难应对需求，或者说难以同时应对多种需求。

`project-share`是基于`svn`开发的多项目管理工具，但是后来我们项目改成了`git`，那这个脚本就不再适用了，其实我可以改造成兼容`git`的，但是每次需求修改就需要调整库代码，这不是很合理---前提是我们希望库是公用的，事实上，从目前项目看，不同项目对脚本操作内容有所不同，但是操作流程和大的框架上还是相似的，如果不能复用，每次都需要创建一份新的脚本库，其实是比较浪费的。

如果`project-share`采用插件系统，那么我们只需要将原来脚本控制的部分改成一个`svn`插件，遇到`git`版本控制系统时只需要替换插件即可---这里还有一个隐形优势，因为公共部分不需要重新开发和测试，实际上更加稳定，开发效率更高，因为我们只需要关注业务需求，公共流程和处理依旧可以使用之前的代码，而无需重新开发。
